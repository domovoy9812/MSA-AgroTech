### <a name="_b7urdng99y53"></a>**Проработка высокоуровневого видения "системы мониторинга свиноферм"**
### <a name="_hjk0fkfyohdk"></a>**Блюштейн Евгений**
### <a name="_uanumrh8zrui"></a>**07.12.2025**
### <a name="_3bfxc9a45514"></a>**Функциональные требования**
| **№** | **Действующие лица или системы** | **Use Case**                                                                 | **Описание**                                                                                                                                                                                                                                                                                                                                            |
|:-----:|:---------------------------------|:-----------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| UC-1  | IoT Шлюз, ПМА, Оператор          | Фиксация отклонений в поведении животных                                     | 1. Модуль ИИ получает записи видеонаблюдения через IoT шлюз<br/>2. Модуль ИИ фиксирует отклонения в поведении животных (беспокойное поведение, драки, задавливание поросят) и оповещает МНЖ<br/>3. МНЖ оповещает оператора через ШУ<br/>4. МНЖ отправляет сообщение в БС для синхронизации с центральным сервером                                       |
| UC-2  | IoT Шлюз, ПМА, Оператор          | Трекинг состояния животных                                                   | 1. Модуль ИИ получает записи видеонаблюдения через IoT шлюз<br/>2. Модуль ИИ отправляет событие об изменении состояния животного в МНЖ<br/>3. В случае критически важных событий, МНЖ оповещает оператора через ШУ<br/>4. МНЖ отправляет сообщение в БС для синхронизации с центральным сервером                                                        |
| UC-3  | IoT Шлюз, ПМА, Оператор          | Учет количества животных                                                     | 1. Модуль ИИ получает записи видеонаблюдения через IoT шлюз<br/>2. На их основе определяет текущее количество животных <br/>3. Передает полученное значение в МНЖ<br/>4. В случае отклонения текущего количества животных от ожидаемого, МНЖ оповещает оператора через ШУ<br/>5. МНЖ отправляет сообщение в БС для синхронизации с центральным сервером |
| UC-4  | ПМА, Управляющий                 | Обновление данных о животных                                                 | 1. Управляющий через API Шлюз обновляет данные о животных(добавление/удаление/изменение)<br/>2. API Шлюз перенаправляет запрос в БС.<br/>3. МНЖ получает сообщение от БС, сохраняет изменения в БД                                                                                                                                                      |
| UC-5  | IoT Шлюз, ПМА, Управляющий       | Изменение рациона животных/обновление данных о запасах корма                 | 1. Управляющий через API Шлюз изменяет рацион животных/обновляет данные о запасах корма<br/>2. API Шлюз перенаправляет запрос в БС.<br/>3. МАК получает сообщение от БС, сохраняет изменения в БД, перепланирует потребление корма<br/>4. Если рацион животных был изменен, через БС отдает команду в IoT Шлюз изменить режим кормления                 |
| UC-6  | ПМА, Оператор                    | Планирование потребления корма и оповещение о необходимости пополнить запасы | 1. ПАК с заданной периодичностью рассчитывает, на сколько дней хватит текущих запасов корма<br/>2. Если запасов корма хватит меньше, чем на N дней, оповещает управляющего через ШУ                                                                                                                                                                     |
| UC-8  | IoT подсистема, Оператор         | Оповещение о неисправности оборудования                                      | 1. IoT шлюз получает сообщение о неисправности одного из IoT устройств <br/>2. Оповещает оператора о неисправности оборудования через ШУ                                                                                                                                                                                                                |
| UC-9  | Управлящий, ПА                   | Получение значений метрик                                                    | 1. Управляющий через REST API запрашивает значение базовых метрик в МА<br/>2. МА возвращает значения базовых метрик                                                                                                                                                                                                                                     |
| UC-10 | Управлящий, ПА                   | Изменение метрик                                                             | 1. Управляющий через REST API добавляет/удаляет/изменяет метрики в МА<br/>2. МА сохраняет изменения                                                                                                                                                                                                                                                     |
### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
| **№** | **Требование**                                                                                                                                                                                    |
|:-----:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| NFR-1 | Система должна обеспечивать высокую отказоустойчивость 99,95%                                                                                                                                     |
| NFR-2 | Система должна быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего                                                                               |
| NFR-3 | Система должна иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения |
| NFR-4 | Система видео-аналитики должна реагировать в реальном времени (миллисекунды)                                                                                                                      |
### <a name="_qmphm5d6rvi3"></a>**Решение**
[Диаграмма контейнеров](C2.puml)
   * В качестве брокера сообщений выбран RabbitMQ, т.к. среднее количество сообщений в системе существенно ниже его пропускной способности, он просто в развертывании, поддерживает кластеризацию, MQTT. 
   * IoT подсистема стоит из:
     * камеры наблюдения, автоматические кормушки/поилки, другие датчики, которые передают данные в IoT шлюз
     * IoT шлюз - отвечает за сбор данных с данных с датчиков и камер наблюдения, отдает команду кормушкам выдать еду согласно режиму питания, заданному МАК
       Шлюз взаимодействует с датчиками по протоколу LoRaWan, т.к. он обеспечивает большую дальность, низкое энергопотребление, и достаточный уровень безопасности.
       Шлюз фильтрует данные с датчиков, в случае неисправности оборудования, отправляет сообщения в ПМА через БС.
       Данные видео наблюдения передаются в модуль ИИ. Шлюз должен поддерживать передачу данных через LTE и WI-FI, чтобы передача видео не прерывалась в случае нестабильной работы одного из этих каналов.
   * Подсистема мониторинга и автоматизации (ПМА) состоит из
     * Модуль ИИ - обрабатывает данные видеонаблюдения, генерирует события (изменение состояния, нежелательное поведение животных) и передает их в МНЖ. Для интеграции использует gRPC для ускорения реакции на происшествия.
     * Модуль наблюдения за животными (МНЖ) - обрабатывает события, при необходимости отправляет нотификации через шлюз уведомлений, отправляет события в агрегатор событий, для последующей синхронизации с ЦС
       Также обрабатывает запросы управляющего на изменение данных о животных
     * Модуль автоматизации кормления (МАК) - обрабатывает запросы управляющего на изменение режима кормления, запасов корма.
       Планирует потребление корма, в случае нехватки корма, посылает уведомление управляющему. Передает новый режим кормление в IoT шлюз
   * В для хранилищ данных на ферме используется postgreSQL, т.к. нагрузка небольшая, поддерживается репликация, часто используется в индустрии
   * Java/Spring Boot используются как основной язык/платформа для разработки микросервисов, т.к. подходят для большинства основных задач, так же как и postgreSQL часто используются в индустрии, просто найти разработчиков с нужным скилсетом
   * В качестве модуля авторизации/аутентификации используется keycloak. Это достаточно популярный продукт, поддерживает стандарты OAuth 2.0/Open ID Connect, поддерживает несколько секьюрити доменов, расширяем, поддерживает HA развертывание.
   * В качестве API шлюза используется Envoy, т.к. обеспечивает высокую производительность, балансировку нагрузки , маршрутизацию, безопасность и наблюдаемость.
   * В качестве хранилища данных для подсистемы аналитики используется СlickHouse, т.к. хорошо подходит для аналитических запросов на больших объемах данных, поддерживает масштабируемость и репликацию, уже используется в компании.
### <a name="_bjrr7veeh80c"></a>**Альтернативы**
Далее представлена диаграмма контейнеров для второго варианта архитектуры из задачи 1.

[Диаграмма контейнеров](C2_alter.puml)

Особенности:
   * Могут быть переиспользованы подсистема аналитики, брокер сообщений (разумно будет перейти kafka, которая уже используется в старом решении), IoT шлюз 
   * IoT шлюз и подсистема аналитики, придется доработать, что увеличивает риски ошибок
   * Передача данных от камеры теперь происходит через мобильный интернет, т.к. источник и обработчик видео уже не находятся в одной локальной сети
   * Отправка уведомлений также требует подключения к интернету, нет необходимости использовать специфические мессенджеры. В будущем после появления мобильного приложения можно будет предейти на push уведомления.

**Недостатки, ограничения, риски**
У альтернативной опции есть дополнительные недостатки:
   * Нужно вносить изменения в существующие модули другой системы. Есть риск возникновения дефектов из-за конфликтов в логике, надежность новой системы зависит от надежности старой
     * Существующие модули могут не поддерживать масштабируемость в достаточной мере, могут быть не рассчитаны на увеличение нагрузки из-за нового решения
     * Рост нагрузки на БД ПМА будет расти с увеличением количества ферм, обслуживаемых системой.
   * Сильная зависимость от качества интернета на ферме, что противоречит требованиям