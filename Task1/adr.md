### <a name="_b7urdng99y53"></a>**Разработка высокоуровневой архитектуры "системы мониторинга свиноферм"**
### <a name="_hjk0fkfyohdk"></a>**Блюштейн Евгений**
### <a name="_uanumrh8zrui"></a>**07.12.2025**
### <a name="_3bfxc9a45514"></a>**Функциональные требования**
| **№** | **Действующие лица или системы** | **Use Case**                                                                 | **Описание**                                                                                                                                                                                                                                                                                          |
|:-----:|:---------------------------------|:-----------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| UC-1  | IoT Подсистема, ПМА, Оператор    | Фиксация отклонений в поведении животных                                     | 1. ПМА получает записи видеонаблюдения через IoT подсистему<br/>2. Фиксирует отклонения в поведении животных (беспокойное поведение, драки, задавливание поросят)<br/>3. Оповещает оператора<br/>4. Синхронизирует событие с ЦС                                                                       |
| UC-2  | IoT Подсистема, ПМА, Оператор    | Трекинг состояния животных                                                   | 1. ПМА получает записи видеонаблюдения через IoT подсистему<br/>2. Фиксирует изменении состояния животного<br/>3. В случае критически важных событий оповещает оператора<br/>4. Синхронизирует событие с ЦС                                                                                           |
| UC-3  | IoT Подсистема, ПМА, Оператор    | Учет количества животных                                                     | 1. ПМА получает записи видеонаблюдения через IoT подсистему<br/>2. На их основе определяет текущее количество животных <br/>3. В случае отклонения текущего количества животных от ожидаемого, оповещает оператора<br/>5. Синхронизирует событие с ЦС                                                 |
| UC-4  | ПМА, Управляющий                 | Обновление данных о животных                                                 | 1. Управляющий через API Шлюз обновляет данные о животных(добавление/удаление/изменение)<br/>2. API Шлюз перенаправляет запрос в ПМА.<br/>3. ПМА сохраняет изменения в БД                                                                                                                             |
| UC-5  | IoT Подсистема, ПМА, Управляющий | Изменение рациона животных/обновление данных о запасах корма                 | 1. Управляющий через API Шлюз изменяет рацион животных/обновляет данные о запасах корма<br/>2. API Шлюз перенаправляет запрос в ПМА.<br/>3. ПМА сохраняет изменения в БД, перепланирует потребление корма<br/>4. Если рацион животных был изменен, отдает команду в IoT Шлюз изменить режим кормления |
| UC-6  | ПМА, Оператор                    | Планирование потребления корма и оповещение о необходимости пополнить запасы | 1. ПМА с заданной периодичностью рассчитывает, на сколько дней хватит текущих запасов корма<br/>2. Если запасов корма хватит меньше, чем на N дней, оповещает управляющего                                                                                                                            |
| UC-8  | IoT подсистема, Оператор         | Оповещение о неисправности оборудования                                      | 1. IoT подсистема получает сообщение о неисправности одного из IoT устройств <br/>2. Оповещает оператора о неисправности оборудования                                                                                                                                                                 |
| UC-9  | Управлящий, ЦС                   | Получение значений метрик                                                    | 1. Управляющий запрашивает значение базовых метрик<br/>2. ЦС возвращает значения базовых метрик                                                                                                                                                                                                       |
| UC-10 | Управлящий, ЦС                   | Изменение метрик                                                             | 1. Управляющий добавляет/удаляет/изменяет метрики<br/>2. ЦС сохраняет изменения                                                                                                                                                                                                                       |
### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
| **№** | **Требование**                                                                                                                                                                                    |
|:-----:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| NFR-1 | Система должна обеспечивать высокую отказоустойчивость 99,95%                                                                                                                                     |
| NFR-2 | Система должна быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего                                                                               |
| NFR-3 | Система должна иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения |
| NFR-4 | Система видео-аналитики должна реагировать в реальном времени (миллисекунды)                                                                                                                      |
### <a name="_qmphm5d6rvi3"></a>**Решение**
[Диаграмма контекста](C1_alter.puml)

Система состоит из следующих подсистем:
1. Агент мониторинга и автоматизации - отвечает за мониторинг и автоматизацию однй фермы. Целиком находится в локальной сети фермы, что дает независимость от качества интернета. состоит из следущюих подсистем:
   * IoT Подсистема - отвечает за сбор данных видеонаблюдения, данных о состоянии оборудования, непосредственное управление сырыми данными
   * Подсистема мониторинга и автоматизации (ПМА) - отвечает за
     * анализ данных, полученных от IoT подсистемы, обнаружение важных событий, отправку уведомлений
     * отправку обработанных данных на центральный сервер
     * хранение и актуализация данных о животных, запасах корма
     * планирование потребления корма, изменение режима кормления животных
   * Агрегатор событий - накапливает события, раз в несколько минут посылает все накопленные события на центральный сервер. Позволяет сократить частоту взаимодействия с центральным сервером, а также не терять события в случае проблем с интернетом.
   * API шлюз - обеспечивает единую точку входа, позволяет реализовать SSO, изолирует внутреннюю реализацию от внешних систем.
2. Центральный сервер, который хранит статистические данные по всем фермам, отвечает за расчет метрик и другую аналитику.

Решение в целом сфокусировано на максимальной автономности (основные подсистемы, обслуживающие ферму находятся в одной подсети), скорости реакции на события, работы в условиях ненадежной работы интернета на ферме
Шлюз уведомлений использует гибридный мессенджер, с поддержкой работы в LAN (для обеспечения доставки уведомлений при отсутствии интернета на ферме)
Высокая отказоустойчивость обеспечивается за счет:
   * исользование для взаимодействия между микросервисами в основном используется брокер сообщений с кластеризацией и подтверждением доставки сообщений
   * использования репликации хранилищ данных, регулярных бэкапов.
   * масштабирования микросервисов, использования API шлюза и service discovery, failover механизмов
   * реализация мониторинга системы для раннего обнаружения сбоев в системе
Для обеспечения максимального покрытия территории камерами, а также наблюдения ночью, используются в основном PTZ-камеры с инфракрасной подсветкой. Их нужно меньше, чем фиксированных камер, для покрытия той же территории. При этом не приводят к существенному снижению качества наблюдения, в отличие от Fish-eye камер. В точках, где часто бывают большие скопления животных, используются фиксированные камеры. 
Для обеспечения мониторинга в реальном времени и максимально быстрой доставки уведомлений используется стриминг видео, а все взаимодействия между микросервисами в цепочке обнаружение событий -> отправка уведомлений используют gRPC вместо брокера сообщений.
Для надежной идентификации животных используются дополнительные визуальные маркеры (ушные бирки/клеймение). В будущем можно реализовать поддержку RFID меток.
С учетом нестабильного WI-FI на фермах для передачи видео используется Ethernet соединение, что позволяет обеспечить максимальные качество и надежность передачи видео.
### <a name="_bjrr7veeh80c"></a>**Альтернативы**
В качестве альтернативы можно рассмотреть решение, в котором в локальной сети фермы остается только IoT подсистема, а все остальные подсистемы переносятся на центральный сервер, что позволяет снизить дублирование комопнентов системы, а также переиспользовать существующие подсистемы. Также IoT подсистема в данном варианте забирает себе функции агрегатора событий и API шлюза.

[Диаграмма контекста](C1.puml)

Однако такой подход имеет серьезный минус - зависимость от качества интернета, т.к. видео надо транслировать через интернет, а не только внутри локальной сети как в первом варианте.
С учетом явного требования на автономную работу при нестабильном интернете, первый вариант является предпочтительным.
**Недостатки, ограничения, риски**
Избыточное дублирование ПМА и связанной инфраструктуры на каждой ферме
Использование проводных камер, требует более затратно при первоначальной установке, в условиях агресивной среды на ферме может потребовать регулярного обслуживание ethernet линий.
